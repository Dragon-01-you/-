# 江西工业智能问答系统部署配置指南

## 目录
1. [后端部署（Render平台）](#后端部署render平台)
2. [前端部署（Vercel平台）](#前端部署vercel平台)
3. [环境变量配置](#环境变量配置)
4. [前后端连接配置](#前后端连接配置)
5. [部署流程总结](#部署流程总结)

## 后端部署（Render平台）

### 1. 选择正确的服务类型
在Render平台上创建新服务时，选择**Web服务**类型。这是因为我们的后端是基于FastAPI开发的动态Web应用程序，需要处理API请求和响应。

### 2. 连接GitHub仓库
- 登录Render账号，点击"新建Web服务"
- 选择连接到GitHub仓库
- 选择你的项目仓库（包含api_server.py等后端文件的仓库）

### 3. 配置部署设置
- **名称**：为你的服务取一个名称
- **环境**：选择Python
- **构建命令**：`pip install -r requirements_api.txt`
- **启动命令**：`uvicorn api_server:app --host 0.0.0.0 --port 10000`
- **实例类型**：选择免费计划即可

### 4. 配置环境变量
在"高级"选项卡中添加以下环境变量：
- `ALLOWED_ORIGINS`: 填入你的Vercel前端域名，如 `https://your-project.vercel.app`
- 其他必要的环境变量（根据项目需求）

### 5. 启动部署
点击"创建Web服务"开始部署过程，部署完成后，Render会提供一个公共URL。

## 前端部署（Vercel平台）

### 1. 准备前端代码
确保前端代码位于单独的仓库或目录中，需要部署到Vercel的具体文件如下：

**必须包含的核心文件：**
- `index.html` - 主页面HTML文件
- `main.js` - 主JavaScript文件，包含API调用逻辑
- `styles.css` - 样式表文件
- `resources/` 目录 - 包含学校logo等资源文件
  - `resources/school-logo.svg` (或其他logo文件)

**可选但建议包含的文件：**
- `design.md` - 设计文档
- `interaction.md` - 交互文档
- `outline.md` - 大纲文档

**注意事项：**
1. 确保main.js中的API地址配置正确（已实现动态获取功能）
2. 所有文件应直接位于仓库根目录或同一目录下（resources目录除外）
3. Vercel会自动检测静态网站并正确配置路由

### 2. 配置API地址
在main.js中，我们已经实现了动态API地址获取功能：
```javascript
function getApiUrl() {
  // 优先使用环境变量
  if (process.env.API_URL) {
    return process.env.API_URL;
  }
  
  // 开发环境使用localhost
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    return 'http://localhost:8000/api/ask';
  }
  
  // 生产环境使用相对路径或配置的后端地址
  return '/api/ask'; // 或直接指向你的Render后端地址
}
```

### 3. 部署到Vercel

#### 基本部署步骤
- 登录Vercel账号
- 点击"新建项目"
- 选择"导入"方式（GitHub或直接上传）
- 选择你的前端代码仓库

#### 环境变量配置（重要）
在部署配置页面中，找到"环境变量"部分，添加以下环境变量：
- **变量名**：`API_URL`
- **值**：输入你的Render后端API地址，格式为 `https://your-render-backend-url.com/api/ask`

**注意**：根据main.js中的实现，这个环境变量会被优先使用，确保前端能够正确连接到后端服务。

#### 部署设置
- 保持其他默认配置
- 点击"部署"按钮开始部署

#### 完成部署
- 部署完成后，Vercel会提供一个公共URL
- 复制这个URL，稍后需要添加到Render的ALLOWED_ORIGINS环境变量中

## 环境变量配置

### 1. 后端环境变量（Render）
- `ALLOWED_ORIGINS`: 允许访问API的域名列表，多个域名用逗号分隔
- 其他项目所需的环境变量

### 2. 前端环境变量（Vercel）
可以在Vercel项目设置中配置以下环境变量：
- `API_URL`: 指向你的Render后端API地址

## 前后端连接配置

### 1. CORS配置（已实现）
在后端api_server.py中，我们已配置CORS中间件支持动态域名：
```python
# 从环境变量获取允许的源
allowed_origins = os.getenv("ALLOWED_ORIGINS", "*").split(",")

# 配置CORS中间件
app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2. API地址配置（已实现）
在前端main.js中，我们已实现动态API地址获取逻辑。

## 部署流程总结

1. **准备工作**:
   - 将前后端代码分别上传到GitHub仓库
   - 确保requirements_api.txt包含所有必要的依赖

2. **后端部署**:
   - 在Render上创建Web服务
   - 配置环境变量，特别是ALLOWED_ORIGINS
   - 获取Render提供的后端URL

3. **前端部署**:
   - 在Vercel上创建项目
   - 配置API_URL环境变量指向Render后端
   - 获取Vercel提供的前端URL

4. **验证连接**:
   - 更新Render的ALLOWED_ORIGINS环境变量，添加Vercel前端URL
   - 重启Render服务
   - 访问前端页面，测试API调用是否正常工作

完成以上步骤后，你的江西工业智能问答系统应该能够正常运行，并实现前后端的正确通信。

本文档提供系统部署到GitHub和Vercel的详细配置说明，特别是前后端连接相关的配置。

## 一、前端配置（Vercel部署）

### 1. Vercel环境变量配置

部署到Vercel时，需要设置以下环境变量：

| 环境变量名 | 说明 | 示例值 | 是否必需 |
|---------|-----|-------|-------|
| `API_URL` | 后端API地址 | `https://your-backend.onrender.com/api/ask` | 否（默认使用相对路径） |

设置方法：
1. 登录Vercel控制台
2. 进入您的项目设置
3. 选择"Environment Variables"选项卡
4. 点击"Add New"按钮添加环境变量

### 2. Vercel代理配置（可选）

如果不想在前端代码中硬编码API地址，可以使用Vercel的代理功能：

1. 在前端目录创建`vercel.json`文件：

```json
{
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "https://your-backend.onrender.com/api/:path*"
    }
  ]
}
```

2. 将此文件添加到GitHub仓库中

## 二、后端配置（Render.com部署）

### 1. Render环境变量配置

以下是部署时需要配置的所有必要环境变量：

#### 大模型API配置
| 环境变量名 | 说明 | 示例值 | 是否必需 |
|---------|-----|-------|-------|
| `MODEL_API_BASE` | 大模型API的基础URL地址 | `https://api.siliconflow.cn/v1` | 否（有默认值） |
| `MODEL_API_KEY` | 大模型API的访问密钥 | - | 是 |
| `MODEL_NAME` | 使用的模型名称 | `deepseek-ai/DeepSeek-R1-Distill-Qwen-7B` | 否（有默认值） |
| `MODEL_TIMEOUT` | API请求超时时间（秒） | `100` | 否（有默认值） |

#### 搜索服务配置
| 环境变量名 | 说明 | 示例值 | 是否必需 |
|---------|-----|-------|-------|
| `GUGUDATA_ENABLED` | 是否启用Gugudata搜索服务 | `true`或`false` | 否（默认`false`） |
| `GUGUDATA_API_KEY` | Gugudata搜索服务API密钥 | - | 否（仅当启用Gugudata时需要） |
| `SERPAPI_ENABLED` | 是否启用SERPAPI搜索服务 | `true`或`false` | 否（默认`false`） |
| `SERPAPI_API_KEY` | SERPAPI搜索服务API密钥 | - | 否（仅当启用SERPAPI时需要） |

#### 应用安全配置
| 环境变量名 | 说明 | 示例值 | 是否必需 |
|---------|-----|-------|-------|
| `ALLOWED_ORIGINS` | CORS允许的源 | `https://your-frontend.vercel.app,http://localhost:3000` | 否（默认允许所有） |
| `PORT` | 服务端口（Render自动设置） | `10000` | 否（Render自动处理） |
| `APP_SECRET_KEY` | 应用的密钥，用于会话管理 | - | 是 |
| `DEBUG` | 调试模式开关 | `true`或`false` | 否（生产环境建议`false`） |

设置方法：
1. 登录Render控制台
2. 进入您的Web Service设置
3. 选择"Environment"选项卡
4. 添加所需的环境变量

配置建议：
1. 开发环境可以使用.env文件配置这些变量
2. 敏感信息（如API密钥）应妥善保管，不要提交到代码仓库
3. 生产环境应确保ALLOWED_ORIGINS配置为具体的前端域名，而不是使用通配符"*"

### 2. 构建和启动命令

| 命令类型 | 命令内容 |
|--------|--------|
| Build Command | `pip install -r requirements_api.txt` |
| Start Command | `uvicorn api_server:app --host 0.0.0.0 --port $PORT` |

## 三、部署流程总结

1. **代码准备**：
   - 确保前端`main.js`中的`getApiUrl()`方法配置正确
   - 确保后端`api_server.py`中的CORS配置正确
   - 创建`vercel.json`文件（如需要代理功能）

2. **GitHub上传**：
   - 将完整代码上传到GitHub仓库

3. **前端部署（Vercel）**：
   - 从GitHub导入仓库
   - 设置环境变量（如果不使用代理）
   - 部署项目
   - 记录生成的Vercel URL

4. **后端部署（Render）**：
   - 从GitHub导入仓库
   - 设置环境变量（`ALLOWED_ORIGINS`设置为Vercel URL）
   - 部署项目
   - 记录生成的Render URL

   **Render平台具体配置：**
   - **环境**：选择 `Python 3`
   - **构建命令**：`pip install -r requirements_api.txt`
   - **启动命令**：`uvicorn api_server:app --host 0.0.0.0 --port 10000`
   - **环境变量**：
     - 添加 `ALLOWED_ORIGINS`：设置为 `*`（测试时）或最终的Vercel URL
     - 根据需要添加其他环境变量（如LLM相关配置）
   - **实例类型**：建议选择至少 `标准` 类型以确保足够的内存运行向量数据库

   **关于Render API地址：**
   - Render API地址是在部署过程完成后由Render平台自动生成的
   - 部署成功后，您可以在Render控制台的项目页面找到这个URL
   - 格式通常为：`https://[项目名称]-[随机字符].onrender.com`
   - 这个URL就是您的后端API服务地址，需要在前端配置中使用
   - 完整的API端点路径为：`https://[项目名称]-[随机字符].onrender.com/api/ask`

   **关于后端入口文件(api_server.py)：**
   - api_server.py是系统的后端入口文件，负责启动和运行FastAPI应用
   - 原因：
     1. 它定义了FastAPI应用实例(app)并配置了所有API端点
     2. 它包含了应用的完整生命周期管理（启动和关闭事件）
     3. 它处理CORS配置，允许前端跨域访问
     4. 它包含标准的Python程序入口点(`if __name__ == "__main__":`)
     5. 部署命令`uvicorn api_server:app`直接指向此文件的app实例
   - 此文件集成了所有核心服务：LLM服务、向量数据库、缓存系统和请求速率限制
   - 它实现了API请求处理和响应格式化的全部逻辑

5. **最终配置**：
   - 如果使用代理：确保`vercel.json`中的目标地址设置为Render URL
   - 如果不使用代理：更新Vercel环境变量`API_URL`为Render URL

6. **重新部署前端**：
   - 更新配置后重新部署前端以应用更改

## 四、验证部署

部署完成后，您可以通过以下方式验证前后端连接是否正常：

1. 访问前端Vercel URL
2. 在聊天框中输入问题
3. 如果收到回答，说明连接成功

## 五、故障排除

### 常见问题

1. **CORS错误**：
   - 检查后端`ALLOWED_ORIGINS`环境变量是否包含前端URL
   - 确认URL格式是否正确（包括协议http/https）

2. **API调用失败**：
   - 检查前端`API_URL`配置是否正确
   - 验证后端服务是否正常运行
   - 查看浏览器控制台和网络请求日志

3. **代理配置问题**：
   - 确认`vercel.json`文件格式正确且已上传
   - 验证代理规则是否正确指向后端API

如有其他问题，请检查部署平台的日志获取更详细的错误信息。